# Architecture and data flow

CROW is implemented as a hierarchy of Vue.js components that can be found in the `src/components` directory. 


    App
        └── Crow
            ├── VPChart
            │   ├── DailyLines
            │   └── ColorLegend
            ├── VPIChart
            │   └── DailyLines
            └── TimelineChart

Understanding the role of each component in the component tree allows understanding of the data flow.

## App
App is the root component and implements a few global features such as URL management and page layout (toolbar, ...) but is not very ionteresting in terms of data.

## Crow

TODO: add form screenshot

Crow is the largest component and in charge of:

- displaying the main form (at site, date, interval, ...)
- loading, transforming and passing (to other components in charge of the visualizations) the data. That happens each time the form change, and at inital page load. 

This process is described with more details below:

The data originates in data files (vertical profile of birds, generated by [vol2bird](https://github.com/adokter/vol2bird)) stored on an HTTP server. Those (tab-separated values) text files contains several variables related to the presence of birds (density, speed, reflectivity, ...), grouped by date (first column), time (second column) and height (third column). The structure in the source data files is therefore a flat table. See for example the [data file for the radar at site Helcheteren](https://opendata.meteo.be/ftp/observations/radar/vbird/behel/2020/behel_vpts_20201101.txt) on November 1st, 2020.

However for performance reasons, the Crow compoment holds this data in a `radarVtps` variable organized as a tree of objects.


    radarVtps (Object)
        ├── 1604185200000 (Object - timestamp)
        │   ├── heightData (Object - vertical profile of birds for this timestamp, per altitude)
        │   │   ├── 0 (Object)
        │   │   │   ├── dd: NaN
        │   │   │   ├── dens: 0
        │   │   │   └── ...
        │   │   ├── 1000 (Object)
        │   │   │   ├── dd: 3.24
        │   │   │   └── dens: 1.01
        │   │   └── ...
        │   └── sunAltitude: -53.03 (Number: Sun altitude at the radar site for at this timestamp )
        └── 1604185500000 (Object - timestamp)
            └── ...



1) the radarVtps object is initialized according to the selected time range and radar. Sun altitudes are also computed and set.
2) data file(s) are loaded via AJAX, and their content is used to populate radarVtps (more specifically, the various properties in each timestamp -> heightdata entries)
3) this data is transformed via computed properties and passed to the child components (that are in charge of the visulization): VPChart receive a flattened version of radarVtps (`radarVtpsAsArray`, similar to the strcture of the initial data files), VPIChart receives vertically integrated profiles (see `integrateProfile` function in `helpers.ts`) and TimelineChart receive a simple arrays with the sun altitude for each shown time period.

TODO: better description the various itnermediate functions and types.
TODO: try to simplify types: VTPSEntry vs VTPSDataRow vs VTPSDataRowFromFile

## VPChart
TODO: short description + screenshot 

## VPIChart
TODO: short description + screenshot 

## TimelineChart
TODO: short description + screenshot 

## DailyLines
TODO: short description + screenshot 

## ColorLegend
TODO: short description + screenshot 
 
# Other (than data flow) considerations:

- config loaded from config.ts
- typescript considerations

